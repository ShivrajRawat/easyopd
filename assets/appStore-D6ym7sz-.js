import{r as f,bt as Gt,bu as Kt,bv as kt,c as y,bj as zt,V as Yt,bw as H,bx as rt,by as j,bz as ut,bA as Jt,bB as dt,bC as Xt,bD as Zt,bE as Qt,bF as te,bG as ee,bH as oe,bI as ne,bc as ae,aK as ce,bJ as se,bK as ie,bL as le,R,bM as V,bN as re,P as _,bO as ue,bP as de,K as fe,a4 as pe,bQ as he,bR as ve}from"./index-QxsQlh4-.js";import{d as ge}from"./dateUtil-H8p96JqU.js";const me=kt?window.navigator:void 0;function De(){const e=f(!1);return zt()&&Yt(()=>{e.value=!0}),e}function ye(e){const n=De();return y(()=>(n.value,!!e()))}function we(e={}){const{enableHighAccuracy:n=!0,maximumAge:c=3e4,timeout:i=27e3,navigator:u=me,immediate:r=!0}=e,d=ye(()=>u&&"geolocation"in u),w=f(null),S=Gt(null),L=f({accuracy:0,latitude:Number.POSITIVE_INFINITY,longitude:Number.POSITIVE_INFINITY,altitude:null,altitudeAccuracy:null,heading:null,speed:null});function D(E){w.value=E.timestamp,L.value=E.coords,S.value=null}let p;function h(){d.value&&(p=u.geolocation.watchPosition(D,E=>S.value=E,{enableHighAccuracy:n,maximumAge:c,timeout:i}))}r&&h();function v(){p&&u&&u.geolocation.clearWatch(p)}return Kt(()=>{v()}),{isSupported:d,coords:L,locatedAt:w,error:S,resume:h,pause:v}}Array.prototype.pushWithDedupe=function(n,c){const i=this;if(!Array.isArray(n)&&!Array.isArray(i)&&!c)return i;const u=(r,d)=>c?r[c]==d[c]:r==d;return n.forEach(r=>{const d=i.find(w=>u(w,r));d?Object.assign(d,r):i.push(r)}),i};Array.prototype.difference=function(n){return this.filter(i=>!n.includes(i))};const ft={city:{collection:"cities",source:"cache"},hospital:{collection:"hospitals",source:"cache"},doctor:{collection:"doctors",source:"cache"},patient:{collection:"patients",source:"cache"},appointment:{collection:"appointments",source:"server"},docQueue:{collection:"docqueues",source:"server"}};function x(e){return ft[e].collection}function pt(e){return ft[e].source}function Le(e,n){try{delete e.id}catch{}}async function ht(e,n){try{if(!n)return n;console.log(`save:Saving ${e} `,n);const c=n.id;Le(n,e);let i;return c?(i=ut(j,x(e),c),await Jt(i,n,{merge:!0})):i=await Xt(dt(j,x(e)),n),console.log(`save:saved ${e} with id: `,i.id),n.id=i.id,n}catch(c){console.error(`Error adding ${e}: `,c)}}async function F(e,n){try{let c,i=pt(e);const u=ut(j,x(e),n);let r=await Zt(u);return!r.exists()&&i=="cache"&&(i="server",r=await Qt(u)),r.exists()?(c=r.data(),c.id=u.id):console.log("No such document!"),c}catch(c){console.error("Error getting data: ",c)}}async function A(e,...n){try{console.log("queryData "+e,n);const c=[],i=te(dt(j,x(e)),...n);let u=pt(e),r=await lt(i,u);return r.size==0&&u=="cache"&&(u="server",r=await lt(i,u)),r.forEach(d=>{const w=d.data(),S=Object.assign({},w,{id:d.id});c.push(S)}),console.log("queryData result"+e,c),c}catch(c){console.error("Error queryData: ",c)}}async function lt(e,n){let c=null;return n=="cache"?c=await ee(e):n=="server"&&(c=await oe(e)),c}async function be(){return console.log("getAllCities"),(await A("city")).map(e=>({name:e.id}))}async function Ie(e){return console.log("getCity",e),F("city",e)}async function Pe(){return A("doctor")}async function Ce(e){return F("hospital",e)}async function Ae(e){return A("hospital",H(rt(),"in",e))}async function Se(e){return A("hospital",H("city","==",e))}async function He(e){return F("doctor",e)}async function Ee(e){return A("doctor",H(rt(),"in",e))}async function Oe(e){return A("doctor",H("hid","==",e))}async function Me(e){return A("patient",H("uid","==",e))}async function Ne(e,n){const c={...n,id:n.id,userId:e};return ht("patient",c)}async function Re(e,n){return A("appointment",H("pid","in",e),H("dt","in",n))}async function We(e){return ht("appointment",e)}const m={savePatient:Ne,saveAppointment:We,getAllCities:be,getCity:Ie,getAllDoctors:Pe,getDoctor:He,getAppointments:Re,getHospital:Ce,getDoctorsByHospital:Oe,getHospitalsByCity:Se,getHospitals:Ae,getPatients:Me,getDoctors:Ee},vt=[{local:"date",remote:"dt"},{local:"time",remote:"tm"},{local:"id",remote:"id"},{local:"doctorId",remote:"did"},{local:"patientId",remote:"pid"},{local:"queueId",remote:"qid"}],je=[{local:"id",remote:"id"},{local:"name",remote:"name"},{local:"city",remote:"city"},{local:"address",remote:"add"},{local:"phone",remote:"phone"},{local:"photo",remote:"photo"},{local:"website",remote:"ws"}],xe=[{local:"id",remote:"id"},{local:"name",remote:"name"},{local:"city",remote:"city"},{local:"avatar",remote:"avtr"},{local:"department",remote:"dept"},{local:"expertise",remote:"expt"},{local:"hospitalId",remote:"hid"},{local:"profileUrl",remote:"purl"},{local:"qual",remote:"qual"},{local:"schedules",remote:"schs"},{local:"speciality",remote:"sp"},{local:"description",remote:"desc"}],qe=[{local:"id",remote:"id"},{local:"name",remote:"name"},{local:"address",remote:"add"},{local:"phone",remote:"phone"},{local:"age",remote:"age"},{local:"dob",remote:"dob"},{local:"gender",remote:"gen"}],Be=[{local:"days",remote:"d"},{local:"start",remote:"s"},{local:"end",remote:"e"}];function Te(e,n){const c={};return Object.keys(e).forEach(i=>{var r;const u=((r=n.find(d=>d.local==i))==null?void 0:r.remote)||i;c[u]=e[i]}),c}function W(e,n){const c={};return Object.keys(e).forEach(i=>{const u=n.find(d=>d.remote==i),r=""+((u==null?void 0:u.local)||i);if(r){const d=e[i];c[r]=u&&u.lfmt?u.lfmt(d):d}else console.log("fromRemote:localProp is null",r)}),c}function Ve(e){return Te(e,vt)}function _e(e){const n=W(e,vt);return new ae(n)}function Fe(e){return e.map(n=>_e(n))}function Ue(e){return W(e,je)}function $e(e){return e.map(n=>Ue(n))}function Ge(e){const n=W(e,xe);return n.schedules=ze(n.schedules||[]),new ne(n)}function Ke(e){return e.map(n=>Ge(n))}function ke(e){return new ce(W(e,Be))}function ze(e){return e.map(n=>ke(n))}function Ye(e){return W(e,qe)}function Je(e){return e.map(n=>Ye(n))}const Xe=fe,Ze=pe,eo=se("appStore",()=>{const{isSupported:e,coords:n,error:c,resume:i,pause:u}=we({immediate:!1}),r=f(!1),d=f(""),w=y(()=>ie()),S=f([]),L=f([]),D=f([]),p=f([]),h=f([]),v=f([]),E=le(),O=f(E.city||""),M=f(""),N=f(""),q=f(""),U=f(null),$=f(""),I=f({ids:[],load:!1}),gt=f({ids:[],load:!1}),mt=f({ids:[],load:!1});y(()=>L.value.map(t=>t.name).filter(t=>t!=null)),y(()=>D.value.map(t=>t.id).filter(t=>t!=null));const Dt=y(()=>p.value.map(t=>t.id).filter(t=>t!=null)),yt=y(()=>h.value.map(t=>t.id).filter(t=>t!=null)),wt=t=>D.value.filter(o=>o.city==t),Lt=t=>p.value.filter(o=>o.hospitalId==t),bt=t=>L.value.find(o=>o.name==t);R(async()=>{if(n.value.latitude===1/0||n.value.longitude===1/0)return;const t=await Ut({lat:n.value.latitude,lon:n.value.longitude});u(),t&&t.city&&(U.value={...t})});const It=y(()=>U),Pt=y(()=>(console.log("computed selectedDoctor"),p.value.find(t=>t.id==N.value))),G=y(()=>D.value.find(t=>t.id==M.value)),Ct=y(()=>h.value.find(t=>t.id==q.value)),At=y(()=>{var t;return{city:O.value,hospital:(t=G.value)==null?void 0:t.name,speciality:"",doctorName:"",text:""}});function K(t="In progress,",o="Please wait..."){r.value=!0,d.value=t+" "+o}function k(){r.value=!1}function St(t){O.value=t,he({city:t})}R(()=>{O.value&&z(O.value).then(()=>J(O.value))},{flush:"post"});function Ht(t){M.value=t}R(()=>{M.value&&Y(M.value).then(()=>Q(M.value))},{flush:"post"});function Et(t){N.value=t}R(()=>{N.value&&Z(N.value)},{flush:"post"});function Ot(t){q.value=t}function Mt(t){return h.value.find(o=>o.id==t||o.name==t)}function Nt(t){const o=(t==null?void 0:t.city)||"",a=(t==null?void 0:t.hospital)||"",s=(t==null?void 0:t.speciality)||"",l=(t==null?void 0:t.doctorName)||"";return p.value.filter(C=>{var at,ct,st,it;return(o.length<=0||((at=C.city)==null?void 0:at.toLocaleLowerCase())==o.toLocaleLowerCase())&&(a.length<=0||((ct=C.hospitalName)==null?void 0:ct.toLocaleLowerCase())==a.toLocaleLowerCase())&&(s.length<=0||((st=C.department)==null?void 0:st.toLocaleLowerCase())==s.toLocaleLowerCase())&&(l.length<=0||((it=C.name)==null?void 0:it.toLocaleLowerCase())==l.toLocaleLowerCase())})}async function Rt(t){K();const o=h.value.find(l=>l.id==t.id),a=Object.assign(o||{},t),s=await m.savePatient(w.value.uid,a);h.value.pushWithDedupe([s],"id"),k()}async function Wt(t){K();const o=v.value.find(l=>l.id==t.id),a=Object.assign(o||{},t),s=await m.saveAppointment({...Ve(a),uid:w.value.uid});v.value.pushWithDedupe([s],"id"),k()}function b(t){console.log("Error:",t),$.value=t}function z(t){return m.getCity(t).then(o=>{et([o])}).catch(b)}function jt(){return L.value.length==0?m.getAllCities().then(t=>{et(t)}).catch(b):Promise.resolve()}async function xt(){}function Y(t){console.log("fetchHospital");const o=D.value.find(a=>a.id==t);return o?P(o,!1):(P(o,!0),m.getHospital(t).then(a=>{B([a])}).catch(b).finally(()=>{P(o,!1)})),Promise.resolve()}function J(t){return new Promise((o,a)=>{const s=V(L.value.find(l=>l.name==t));P(s,!0),m.getHospitalsByCity(t).then(l=>{console.log("city hospitals",l),B(l),o(!0)}).catch(b).finally(()=>{P(s,!1)})})}function X(t){return m.getHospitals(t).then(o=>B(o)).catch(b)}function Z(t){return new Promise((o,a)=>{const s=p.value.find(l=>l.id==t);s?(P(s,!1),o(!0)):(P(s,!0),m.getDoctor(t).then(l=>{T([l]),o(!0)}).catch(b).finally(()=>{P(s,!1)}))})}function Q(t){return new Promise((o,a)=>{const s=V(D.value.find(l=>l.id==t));s.doctorsLoading=!0,m.getDoctorsByHospital(t).then(l=>{T(l),o(!0)}).catch(b).finally(()=>{s.doctorsLoading=!1})})}function qt(t){return new Promise((o,a)=>{m.getDoctors(t).then(s=>{T(s),o(!0)}).catch(s=>{b(s),a(s)})})}function tt(){return new Promise((t,o)=>{if(h.value.length>0)console.log("fetchPatients: already loaded: ",h.value.length),t(!0);else{const a=w.value.uid;a&&m.getPatients(a).then(s=>{h.value.pushWithDedupe(Je(s),"id"),t(!0)}).catch(b)}})}async function Bt(t){await tt();const o=ge(new Date,t),a=yt.value;o.length>0&&a.length>0&&m.getAppointments(a,o).then(async s=>{Tt(s),v.value.forEach(g=>{g.patient||(g.patient=h.value.find(C=>C.id==g.patientId))});const l=v.value.map(g=>g.doctorId).filter(g=>g!=null).difference(Dt.value);l.length>0&&qt(l).then(()=>{v.value.forEach(g=>{g.doctor||(g.doctor=p.value.find(C=>C.id==g.doctorId))})})}).catch(b)}function Tt(t){t&&t.length>0&&(v.value.pushWithDedupe(Fe(t),"id"),v.value=v.value.sort((o,a)=>o.dateValue-a.dateValue))}function et(t){!t||t.length==0||(L.value.pushWithDedupe(t.map(o=>new re(o)).filter(o=>!!o.name),"name"),L.value.forEach(o=>{o.icon=o.icon||Ze,o.hospitals||(o.hospitals=[])}))}function B(t){if(!t||t.length==0)return;const o=$e(t);D.value.pushWithDedupe(o,"id"),D.value.forEach(a=>{a.route=_.HOSPITAL_DETAIL.url(a.id),a.photo=a.photo||Xe,a.profile||ue(a.id).then(s=>a.profile=s).catch(s=>console.log("HospitalProfile download error",s))}),Vt(o.map(a=>a.city))}function T(t){if(!t||t.length==0)return;const o=Ke(t);console.log("processDoctors: after transform",o),p.value.pushWithDedupe(o,"id"),p.value.forEach(a=>{a.route=_.DOCTOR_DETAIL.url(a.id),a.appointmentRoute=_.DOCTOR_APPOINTMENT.url(a.id),a.avatar=a.avatar||de}),nt(o.map(a=>a.hospitalId))}R(()=>{if(console.log("watchEffect:hospitalsToLoad",I.value),I.value.load&&I.value.ids.length>0){const t=[...I.value.ids];X(t).then(()=>{nt(t),I.value.ids=[]})}},{flush:"post"});function ot(t){return[...new Set(t)]}function Vt(t){t=ot(t||[]),t.forEach(o=>{V(bt(o)).hospitals=wt(o)})}function nt(t){const o=[];t=ot(t||[]),console.log("associateDoctorsWithHospitals",t),t.forEach(a=>{const s=D.value.find(l=>l.id==a);s?(s.doctors=Lt(a).map(l=>_t(l,s.name,s.city)),s.specialities=s.doctors.map(l=>l.speciality||l.department).filter(l=>l)):o.push(a)}),I.value.load=!0,I.value.ids=o}function _t(t,o,a){return t.hospitalName=o,t.city=a,t}function P(t,o){t&&(t.loading=o)}function Ft(){i()}async function Ut(t){const o=`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${t.lat}&longitude=${t.lon}&localityLanguage=en`;return await(await fetch(o)).json()}function $t(t){console.log("appStore:authStateChangedListener",t),ve(t)}return{specialities:S,cities:L,hospitals:D,doctors:p,patients:h,appointments:v,errors:$,progress:r,progressMessage:d,hospitalsToLoad:I,doctorsToLoad:gt,citiesToLoad:mt,selectedCity:O,selectedHospitalId:M,selectedDoctorId:N,selectedPatientId:q,searchQuery:At,getPatient:Mt,selectedDoctor:Pt,selectedHospital:G,selectedPatient:Ct,searchDoctors:Nt,currentLocation:It,savePatient:Rt,saveAppointment:Wt,selectCity:St,selectDoctor:Et,selectHospital:Ht,selectPatient:Ot,fetchCities:jt,fetchDoctors:Q,fetchHospitals:J,fetchHospitalByIds:X,fetchSpeciaties:xt,fetchPatients:tt,fetchCity:z,fetchHospital:Y,fetchDoctor:Z,fetchAppointments:Bt,startGeoLocationRetrieval:Ft,authStateChangedListener:$t}});export{eo as u};
